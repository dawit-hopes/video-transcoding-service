<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Video Gallery</title>
    
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 40px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        h1 { text-align: center; font-weight: 300; margin-bottom: 40px; }
        
        /* Grid Layout for Gallery */
        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .video-card {
            background: #2d2d2d;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .video-card:hover { transform: translateY(-5px); }

        .card-header { padding: 15px; border-bottom: 1px solid #444; }
        .card-header h3 { margin: 0; font-size: 1.1rem; color: #3498db; }
        .card-header span { font-size: 0.8rem; color: #888; }
        
        /* Fix Plyr layering */
        .plyr { border-radius: 0 0 12px 12px; }
    </style>
</head>
<body>

    <h1>StreamHub Gallery</h1>
    <div id="gallery">Loading amazing videos...</div>

    <script>
        const gallery = document.getElementById('gallery');

        fetch('http://localhost:8080/list')
            .then(res => res.json())
            .then(videos => {
                gallery.innerHTML = '';
                if (!videos || videos.length === 0) {
                    gallery.innerHTML = '<p style="text-align:center">No videos found.</p>';
                    return;
                }

                videos.forEach(name => {
                    // Create the Card HTML
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${name}</h3>
                            <span>/videos/${name}/master.m3u8</span>
                        </div>
                        <video id="player-${name}" controls crossorigin playsinline poster=""></video>
                    `;
                    gallery.appendChild(card);

                    const videoElement = document.getElementById(`player-${name}`);
                    const source = `http://localhost:8080/videos/${name}/master.m3u8`;

                    // --- The Integration Magic ---
                    if (Hls.isSupported()) {
                        const hls = new Hls();
                        hls.loadSource(source);
                        
                        hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                            
                            const availableQualities = hls.levels.map((l) => l.height);
                            availableQualities.unshift(0); 

                            const player = new Plyr(videoElement, {
                                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                                settings: ['quality', 'speed'],
                                quality: {
                                    default: 0, // Default to Auto
                                    options: availableQualities,
                                    forced: true,
                                    onChange: (e) => updateQuality(e),
                                },
                                i18n: {
                                    qualityLabel: {
                                        0: 'Auto',
                                    },
                                }
                            });

                            function updateQuality(newQuality) {
                                if (newQuality === 0) {
                                    hls.currentLevel = -1;
                                } else {
                                    hls.levels.forEach((level, levelIndex) => {
                                        if (level.height === newQuality) {
                                            hls.currentLevel = levelIndex;
                                        }
                                    });
                                }
                            }

                            hls.attachMedia(videoElement);
                            window.hls = hls; 
                        });

                    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        videoElement.src = source;
                        const player = new Plyr(videoElement);
                    }
                });
            })
            .catch(err => {
                console.error(err);
                gallery.innerHTML = `<p style="color:red; text-align:center;">Error loading gallery.</p>`;
            });
    </script>
</body>
</html>